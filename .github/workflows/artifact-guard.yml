name: Artifact Guard

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fail if scan artifacts exist in results/
        run: |
          set -e
          shopt -s nullglob
          files=(results/*)
          # Allow only .gitkeep
          for f in "${files[@]}"; do
            base="$(basename "$f")"
            if [ "$base" != ".gitkeep" ]; then
              echo "Disallowed artifact found in results/: $f";
              exit 1;
            fi
          done

      - name: Fail if scan artifacts exist in reports/
        run: |
          set -e
          shopt -s nullglob
          files=(reports/*)
          for f in "${files[@]}"; do
            base="$(basename "$f")"
            if [ "$base" != ".gitkeep" ]; then
              echo "Disallowed artifact found in reports/: $f";
              exit 1;
            fi
          done

      - name: Fail if legacy Node CLI reference exists
        run: |
          if grep -R "scorpion-node" -n .; then
            echo "Found legacy Node CLI references (scorpion-node). Please remove.";
            exit 1;
          fi
          exit 0