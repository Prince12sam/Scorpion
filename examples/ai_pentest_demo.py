#!/usr/bin/env python3
"""
AI Pentesting Demo Script
Demonstrates how to use Scorpion's AI pentesting programmatically
"""

import asyncio
import json
import os
from python_scorpion.ai_pentest import (
    AIPentestAgent,
    AIPentestConfig,
    PrimaryGoal,
    AutonomyLevel,
    StealthLevel,
    RiskTolerance
)


async def example_basic_test():
    """Basic AI pentest example"""
    print("=" * 70)
    print("Example 1: Basic AI Penetration Test")
    print("=" * 70)
    
    config = AIPentestConfig(
        target="example.com",
        primary_goal=PrimaryGoal.COMPREHENSIVE,
        secondary_goals=[],
        time_limit=60,  # 60 minutes
        stealth_level=StealthLevel.MODERATE,
        autonomy_level=AutonomyLevel.SEMI_AUTONOMOUS,
        risk_tolerance=RiskTolerance.MEDIUM,
        ai_provider="openai",
        api_key=os.getenv("SCORPION_AI_API_KEY"),
        model="gpt-4",
        max_iterations=10
    )
    
    agent = AIPentestAgent(config)
    report = await agent.execute()
    
    print("\n" + "=" * 70)
    print("Test Complete!")
    print("=" * 70)
    print(f"Findings: {report['summary']['total_findings']}")
    print(f"Actions: {report['summary']['total_actions']}")
    print(f"Duration: {report['summary']['duration_minutes']} minutes")
    
    return report


async def example_web_exploitation():
    """Web application focused test"""
    print("=" * 70)
    print("Example 2: Web Application Exploitation")
    print("=" * 70)
    
    config = AIPentestConfig(
        target="https://demo.testfire.net",  # OWASP demo site
        primary_goal=PrimaryGoal.WEB_EXPLOITATION,
        secondary_goals=["data_access"],
        time_limit=90,
        stealth_level=StealthLevel.MODERATE,
        autonomy_level=AutonomyLevel.SEMI_AUTONOMOUS,
        risk_tolerance=RiskTolerance.MEDIUM,
        ai_provider="openai",
        api_key=os.getenv("SCORPION_AI_API_KEY"),
        model="gpt-4-turbo",
        max_iterations=15
    )
    
    agent = AIPentestAgent(config)
    report = await agent.execute()
    
    # Display web vulnerabilities found
    web_vulns = [f for f in report['detailed_findings'] if f['category'] == 'web_application']
    
    print(f"\nWeb Vulnerabilities Found: {len(web_vulns)}")
    for vuln in web_vulns[:5]:  # Show top 5
        print(f"  - [{vuln['severity'].upper()}] {vuln['description']}")
    
    return report


async def example_network_mapping():
    """Network infrastructure mapping"""
    print("=" * 70)
    print("Example 3: Network Infrastructure Mapping")
    print("=" * 70)
    
    config = AIPentestConfig(
        target="192.168.1.1",
        primary_goal=PrimaryGoal.NETWORK_MAPPING,
        secondary_goals=[],
        time_limit=45,
        stealth_level=StealthLevel.LOW,  # Fast scanning
        autonomy_level=AutonomyLevel.SEMI_AUTONOMOUS,
        risk_tolerance=RiskTolerance.MEDIUM,
        ai_provider="openai",
        api_key=os.getenv("SCORPION_AI_API_KEY"),
        model="gpt-3.5-turbo",  # Cheaper model
        max_iterations=8
    )
    
    agent = AIPentestAgent(config)
    report = await agent.execute()
    
    # Display discovered services
    services = [f for f in report['detailed_findings'] if 'port' in f['description'].lower()]
    
    print(f"\nServices Discovered: {len(services)}")
    for service in services[:10]:  # Show top 10
        print(f"  - {service['description']}")
    
    return report


async def example_high_stealth():
    """High stealth red team operation"""
    print("=" * 70)
    print("Example 4: High Stealth Red Team Operation")
    print("=" * 70)
    
    config = AIPentestConfig(
        target="target.com",
        primary_goal=PrimaryGoal.COMPREHENSIVE,
        secondary_goals=["privilege_escalation", "data_access"],
        time_limit=180,  # 3 hours
        stealth_level=StealthLevel.HIGH,  # Slow and careful
        autonomy_level=AutonomyLevel.SEMI_AUTONOMOUS,
        risk_tolerance=RiskTolerance.HIGH,  # Requires authorization!
        ai_provider="anthropic",
        api_key=os.getenv("ANTHROPIC_API_KEY"),
        model="claude-3-opus-20240229",
        max_iterations=20
    )
    
    agent = AIPentestAgent(config)
    report = await agent.execute()
    
    print("\nHigh-Risk Findings:")
    critical_high = [f for f in report['detailed_findings'] 
                     if f['severity'] in ['critical', 'high']]
    
    for finding in critical_high:
        print(f"  - [{finding['severity'].upper()}] {finding['description']}")
        print(f"    Exploitation Potential: {finding['exploitation_potential']}")
        print(f"    Recommended Action: {finding['recommended_action']}")
        print()
    
    return report


async def example_local_ai():
    """Using local AI model (free & private)"""
    print("=" * 70)
    print("Example 5: Local AI Model (Free & Private)")
    print("=" * 70)
    
    # Requires Ollama running locally: ollama serve
    # And model pulled: ollama pull llama3
    
    config = AIPentestConfig(
        target="example.com",
        primary_goal=PrimaryGoal.NETWORK_MAPPING,
        secondary_goals=[],
        time_limit=60,
        stealth_level=StealthLevel.MODERATE,
        autonomy_level=AutonomyLevel.SEMI_AUTONOMOUS,
        risk_tolerance=RiskTolerance.LOW,
        ai_provider="custom",
        api_key="local",
        api_endpoint="http://localhost:11434/v1/chat/completions",
        model="llama3",
        max_iterations=10
    )
    
    agent = AIPentestAgent(config)
    
    try:
        report = await agent.execute()
        
        print("\n‚úÖ Local AI test complete!")
        print("Benefits: FREE, PRIVATE, UNLIMITED")
        print(f"Findings: {report['summary']['total_findings']}")
        
        return report
    except Exception as e:
        print(f"\n‚ùå Error: {e}")
        print("\nTo use local AI:")
        print("1. Install Ollama: https://ollama.ai")
        print("2. Pull model: ollama pull llama3")
        print("3. Start server: ollama serve")
        return None


async def example_supervised_learning():
    """Supervised mode for learning"""
    print("=" * 70)
    print("Example 6: Supervised Mode (Learning)")
    print("=" * 70)
    
    config = AIPentestConfig(
        target="example.com",
        primary_goal=PrimaryGoal.COMPREHENSIVE,
        secondary_goals=[],
        time_limit=30,
        stealth_level=StealthLevel.MODERATE,
        autonomy_level=AutonomyLevel.SUPERVISED,  # Prompts before each action
        risk_tolerance=RiskTolerance.LOW,
        ai_provider="openai",
        api_key=os.getenv("SCORPION_AI_API_KEY"),
        model="gpt-4",
        max_iterations=5
    )
    
    print("\nSupervised mode: You'll approve each AI action")
    print("Great for learning how AI pentesting works!")
    
    agent = AIPentestAgent(config)
    report = await agent.execute()
    
    print("\nActions taken:")
    for action in report['actions_taken']:
        print(f"  - {action['tool']}: {action['reasoning']}")
    
    return report


async def example_budget_friendly():
    """Budget-friendly test with cost limits"""
    print("=" * 70)
    print("Example 7: Budget-Friendly Test (< $0.50)")
    print("=" * 70)
    
    config = AIPentestConfig(
        target="example.com",
        primary_goal=PrimaryGoal.NETWORK_MAPPING,
        secondary_goals=[],
        time_limit=20,  # Short
        stealth_level=StealthLevel.LOW,  # Fast
        autonomy_level=AutonomyLevel.SEMI_AUTONOMOUS,
        risk_tolerance=RiskTolerance.LOW,
        ai_provider="openai",
        api_key=os.getenv("SCORPION_AI_API_KEY"),
        model="gpt-3.5-turbo",  # Cheapest model
        max_iterations=5  # Limited iterations
    )
    
    agent = AIPentestAgent(config)
    report = await agent.execute()
    
    print(f"\nüí∞ Estimated Cost: $0.10-0.30")
    print(f"Findings: {report['summary']['total_findings']}")
    print(f"Duration: {report['summary']['duration_minutes']} minutes")
    
    return report


async def compare_providers():
    """Compare different AI providers"""
    print("=" * 70)
    print("Example 8: AI Provider Comparison")
    print("=" * 70)
    
    providers = [
        ("openai", "gpt-3.5-turbo", os.getenv("SCORPION_AI_API_KEY")),
        ("anthropic", "claude-3-haiku-20240307", os.getenv("ANTHROPIC_API_KEY")),
    ]
    
    results = {}
    
    for provider, model, api_key in providers:
        if not api_key:
            print(f"\nSkipping {provider} (no API key)")
            continue
        
        print(f"\nTesting with {provider} ({model})...")
        
        config = AIPentestConfig(
            target="example.com",
            primary_goal=PrimaryGoal.NETWORK_MAPPING,
            secondary_goals=[],
            time_limit=15,
            stealth_level=StealthLevel.LOW,
            autonomy_level=AutonomyLevel.SEMI_AUTONOMOUS,
            risk_tolerance=RiskTolerance.LOW,
            ai_provider=provider,
            api_key=api_key,
            model=model,
            max_iterations=3
        )
        
        agent = AIPentestAgent(config)
        report = await agent.execute()
        
        results[provider] = {
            "model": model,
            "findings": report['summary']['total_findings'],
            "actions": report['summary']['total_actions'],
            "duration": report['summary']['duration_minutes']
        }
    
    # Compare results
    print("\n" + "=" * 70)
    print("Provider Comparison Results")
    print("=" * 70)
    
    for provider, data in results.items():
        print(f"\n{provider.upper()} ({data['model']}):")
        print(f"  Findings: {data['findings']}")
        print(f"  Actions: {data['actions']}")
        print(f"  Duration: {data['duration']} min")
    
    return results


def save_report(report, filename):
    """Save report to JSON file"""
    with open(filename, 'w') as f:
        json.dump(report, f, indent=2)
    print(f"\nüìÑ Report saved to: {filename}")


async def main():
    """Run example demonstrations"""
    
    # Check for API key
    if not os.getenv("SCORPION_AI_API_KEY"):
        print("=" * 70)
        print("‚ö†Ô∏è  SCORPION_AI_API_KEY environment variable not set")
        print("=" * 70)
        print("\nPlease set your API key:")
        print("  export SCORPION_AI_API_KEY='sk-...'")
        print("\nGet API keys from:")
        print("  - OpenAI: https://platform.openai.com/api-keys")
        print("  - Anthropic: https://console.anthropic.com/")
        print("\nOr use local AI (free):")
        print("  - Install Ollama: https://ollama.ai")
        print("=" * 70)
        return
    
    print("\n" + "=" * 70)
    print("SCORPION AI PENETRATION TESTING - EXAMPLES")
    print("=" * 70)
    print("\n‚ö†Ô∏è  WARNING: Only test systems you own or have authorization to test!")
    print("\nThese examples demonstrate AI pentesting capabilities.")
    print("Modify targets and configurations for your use cases.\n")
    
    # Select which example to run
    examples = {
        "1": ("Basic Test", example_basic_test),
        "2": ("Web Exploitation", example_web_exploitation),
        "3": ("Network Mapping", example_network_mapping),
        "4": ("High Stealth", example_high_stealth),
        "5": ("Local AI", example_local_ai),
        "6": ("Supervised Learning", example_supervised_learning),
        "7": ("Budget-Friendly", example_budget_friendly),
        "8": ("Compare Providers", compare_providers),
    }
    
    print("Available Examples:")
    for key, (name, _) in examples.items():
        print(f"  {key}. {name}")
    
    print("\nNote: These are code examples, not actual tests.")
    print("To run, uncomment and modify for your targets.")
    
    # Uncomment to run specific example:
    # report = await example_basic_test()
    # save_report(report, "ai_pentest_basic.json")


if __name__ == "__main__":
    # Run examples
    asyncio.run(main())
    
    print("\n" + "=" * 70)
    print("üìö For more information:")
    print("  - Full Guide: AI_PENTESTING_GUIDE.md")
    print("  - Quick Ref: AI_PENTESTING_QUICKREF.md")
    print("  - CLI Usage: scorpion ai-pentest --help")
    print("=" * 70)
